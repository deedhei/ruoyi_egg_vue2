const path = require("path");

// 导入compression-webpack-plugin 开启gzip
const CompressionWebpackPlugin = require("compression-webpack-plugin");
// 定义压缩文件类型
const productionGzipExtensions = ["js", "css"];

function resolve(dir) {
  return path.join(__dirname, dir);
}

module.exports = {
  publicPath: "./",
  lintOnSave: false,
  // 打包时不生成.map文件
  productionSourceMap: false,
  chainWebpack: config => {
    // 配置静态资源图片
    config.module.rules.delete("images");
    // 清除svg默认的处理方式
    config.module.rules.delete("svg");
    config.plugin("html").tap(args => {
      args[0].title = "后台管理系统";
      return args;
    });
  },
  configureWebpack: {
    devtool: "source-map",
    resolve: {
      extensions: [".js", ".vue", ".json"], // 当引入文件时默认先找.js后缀的文件，没找到再从左往右继续
      alias: {
        vue$: "vue/dist/vue.esm.js",
        "@": resolve("src")
      }
    },
    plugins: [
      new CompressionWebpackPlugin({
        filename: "[path].gz[query]",
        algorithm: "gzip",
        test: new RegExp("\\.(" + productionGzipExtensions.join("|") + ")$"), // 匹配文件名
        threshold: 10240, // 对10K以上的数据进行压缩
        minRatio: 0.8,
        deleteOriginalAssets: false // 是否删除源文件
      })
    ],
    performance: {
      hints: false
    },
    module: {
      rules: [
        {
          test: /\.svg$/,
          loader: "svg-sprite-loader",
          include: [resolve("src/static/icons")],
          options: {
            symbolId: "icon-[name]"
          }
        },
        {
          test: /\.(png|jpe?g|gif|webp|svg)(\?.*)?$/,
          exclude: [resolve("src/static/icons")],
          use: [
            {
              loader: "url-loader",
              options: {
                limit: 4096,
                fallback: {
                  loader: "file-loader",
                  options: {
                    name: "img/[name].[hash:8].[ext]"
                  }
                }
              }
            }
          ]
        }
      ]
    }
  },
  devServer: {
    // https: true,
    port: 9528,
    proxy: {
      [process.env.VUE_APP_BASE_API]: {
        target: "http://localhost:7001/api/v1",
        changeOrigin: true,
        pathRewrite: {
          ["^" + process.env.VUE_APP_BASE_API]: "/api/v1"
        }
      },
      "/img_url": {
        target: "http://localhost:7001",
        changeOrigin: true,
        pathRewrite: {
          "^/img_url": ""
        }
      }
    }
  }
};
